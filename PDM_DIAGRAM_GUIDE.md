# PDM 節點式網圖使用指南

## 什麼是 PDM？

**PDM (Precedence Diagramming Method)**，中文稱為「優先圖法」或「節點式網圖」，是一種專案排程的視覺化方法。

### 特點

- **節點代表活動**：矩形框代表每個作業/活動
- **箭線代表依賴**：箭頭表示作業之間的先後關係
- **也稱為 AON**：Activity-on-Node（活動在節點上）

與 **AOA (Activity-on-Arrow)** 的差異：
- AOA：箭線代表活動，節點代表事件
- PDM：節點代表活動，箭線代表依賴（更直觀）

---

## 節點結構

PDM 網圖中的每個節點採用標準的九宮格佈局：

```
┌───────┬───────┬───────┐
│  ES   │ 作業  │  EF   │
│   5   │ 名稱  │  10   │
├───────┼───────┼───────┤
│       │ 工期  │       │
│       │   5   │       │
├───────┼───────┼───────┤
│  LS   │  TF   │  LF   │
│   5   │   0   │  10   │
└───────┴───────┴───────┘
```

### 欄位說明

| 欄位 | 位置 | 說明 |
|------|------|------|
| **ES (Earliest Start)** | 左上格 | 最早開始時間 |
| **作業名稱** | 中上格 | 作業的簡稱 |
| **EF (Earliest Finish)** | 右上格 | 最早完成時間 |
| **工期 (Duration)** | 中心格 | 作業所需天數（粗體） |
| **LS (Latest Start)** | 左下格 | 最晚開始時間 |
| **TF (Total Float)** | 中下格 | 總浮時（粗體） |
| **LF (Latest Finish)** | 右下格 | 最晚完成時間 |

### 節點顏色

- **黃色背景 + 紅色粗框**：要徑作業（TF = 0）
- **黃色背景 + 黑色細框**：一般作業（TF > 0）

這種配色方案與傳統教科書一致，便於教學和理解。

---

## 箭線與依賴類型

### 箭線顏色

- **紅色粗線**：要徑（連接要徑作業）
- **灰色細線**：一般依賴

### 四種依賴類型

PDM 支援四種依賴關係類型：

#### 1. FS (Finish-to-Start) - 完成到開始
```
前置作業 ──FS──> 後續作業
```
- **最常見**的依賴類型
- 前置作業必須「完成」後，後續作業才能「開始」
- **範例**：基礎完成後，才能開始結構施工

#### 2. SS (Start-to-Start) - 開始到開始
```
前置作業 ──SS──> 後續作業
```
- 前置作業「開始」後，後續作業才能「開始」
- **範例**：結構施工開始後，機電配管可以同時開始

#### 3. FF (Finish-to-Finish) - 完成到完成
```
前置作業 ──FF──> 後續作業
```
- 前置作業「完成」後，後續作業才能「完成」
- **範例**：機電安裝完成後，測試工作才能完成

#### 4. SF (Start-to-Finish) - 開始到完成
```
前置作業 ──SF──> 後續作業
```
- 前置作業「開始」後，後續作業才能「完成」
- **較少使用**，通常用於交接情況
- **範例**：新系統啟動後，舊系統維護才能結束

### Lag 值（延遲/提前時間）

箭線上可能顯示 Lag 值，例如：
- **FS (+3)**：完成後延遲 3 天才開始（養護期）
- **SS (-2)**：可以提前 2 天開始（快速跟進）

---

## 如何閱讀 PDM 網圖

### 佈局方式

本系統採用**橫向佈局**（從左到右）：
- **時間軸**：從左到右代表時間推進
- **垂直排列**：相同時間點（ES）的作業垂直排列
- **智能路徑**：
  - 箭線以直線為主，清晰易讀
  - 自動避開節點，不會穿過作業
  - 防止多條線重疊，自動偏移避讓

### 步驟 1：找出起始作業
- 沒有輸入箭線的節點
- 位於圖的**最左側**

### 步驟 2：追蹤要徑
- 尋找紅色粗框節點和紅色箭線
- 從左到右追蹤，形成完整路徑
- 這條路徑決定專案總工期

### 步驟 3：檢查浮時
- 黑色細框節點有浮時（TF > 0）
- 可以延遲而不影響專案

### 步驟 4：確認依賴關係
- 檢查箭線上的類型標示（若非 FS）
- 理解作業之間的邏輯關係
- 箭線以直線連接，清晰展示依賴

### 智能路徑規劃說明

系統採用多層次智能路徑演算法，優先使用簡潔路徑，確保：
1. **線不穿過節點**
2. **線減少彎曲** 
3. **線不會重疊**

#### 路徑優先級策略

**策略 1：直線（零彎曲）**
- 條件：同一水平線 + 無障礙物
- 路徑：`A ────────> B`
- 優點：最簡潔，最易讀

**策略 2：標準三段式（兩個彎）**
- 條件：垂直距離適中 + 中間無障礙
- 路徑：`A ───┐`
         `    │`
         `    └─> B`
- 優點：彎曲少，路徑直接

**策略 3：偏移三段式（兩個彎 + 小偏移）**
- 條件：需要避開障礙或避免重疊
- 路徑：`A ───┐  ╱`
         `    │ ╱  （偏移）`
         `    └──> B`
- 優點：避障同時保持簡潔

**策略 4：繞行路徑（三個彎）**
- 條件：中間有障礙，需要大幅繞行
- 路徑：`A ─┐    ┌─> B`
         `  └────┘  （繞行）`
- 優點：確保不穿過任何節點

#### 避障機制

1. **檢測障礙**
   - 檢查直線路徑是否穿過節點
   - 檢查垂直線段是否穿過節點
   - 檢查水平線段是否穿過節點

2. **選擇繞行方向**
   - 優先選擇與目標同方向（減少彎曲）
   - 檢查上下空間是否有障礙
   - 選擇空間較大的路徑

3. **動態調整**
   - 根據節點分佈調整路徑
   - 自動計算最佳繞行點

#### 防重疊機制

1. **路徑追蹤**
   - 記錄所有已繪製路徑的起終點
   - 識別相似路徑（使用座標分組）

2. **智能偏移**
   - 第一條線：基礎路徑
   - 第二條線：向上偏移
   - 第三條線：向下偏移
   - 第四條線：向上偏移（更大）
   - 依此類推，交替上下

3. **最小間距**
   - 線條間保持至少 12px 間距
   - 確保箭頭和標籤不重疊

#### 佈局優化

- **增大節點間距**：減少線條交叉機會
  - 橫向間距：300px
  - 縱向間距：160px
  
- **預留繞行空間**：節點周圍保留足夠空間供箭線繞行

---

## 互動功能

### 基本操作

| 操作 | 方法 | 說明 |
|------|------|------|
| **移動視圖** | 滑鼠拖曳 | 在空白處按住並拖曳 |
| **縮放** | 滑鼠滾輪 | 向上滾動放大，向下滾動縮小 |
| **查看詳情** | 點擊節點 | 顯示作業完整資訊 |
| **懸停提示** | 滑鼠移到節點上 | 節點邊框加粗 |

### 工具按鈕

| 按鈕 | 功能 |
|------|------|
| **重置視圖** | 回到初始縮放和位置 |
| **自動縮放** | 自動調整至最佳顯示大小 |
| **顯示詳細資訊** | 切換是否顯示 ES/EF/LS/LF/TF |

---

## 使用場景

### 1. 教學用途
- 解釋 CPM 計算過程
- 展示 Forward Pass 和 Backward Pass
- 理解浮時的概念

### 2. 專案規劃
- 視覺化專案邏輯
- 識別要徑
- 找出可優化的地方

### 3. 簡報展示
- 向業主說明施工順序
- 展示專案邏輯關係
- 強調關鍵控制點

### 4. 問題分析
- 找出工期瓶頸
- 分析依賴關係是否合理
- 評估趕工策略

---

## 範例解讀

### 簡單線性專案（橫向佈局）

```
┌─────┐  FS  ┌─────┐  FS  ┌─────┐
│  A  │─────>│  B  │─────>│  C  │
│ D:5 │      │ D:3 │      │ D:4 │
│TF:0 │      │TF:0 │      │TF:0 │
└─────┘      └─────┘      └─────┘
(紅框)       (紅框)       (紅框)
```

- 從左到右按時間順序排列
- 全部為要徑作業（紅色粗框）
- 總工期 = 5 + 3 + 4 = 12 天
- 任何作業延誤都會影響總工期

### 有平行作業的專案（橫向佈局）

```
             ┌─────┐
         ┌──>│  B  │─┐
         │   │ D:5 │ │
         │   │TF:2 │ │
┌─────┐ │FS └─────┘ │FS ┌─────┐
│  A  │─┤          └───>│  D  │
│ D:3 │ │                │ D:4 │
│TF:0 │ │   ┌─────┐     │TF:0 │
└─────┘ └──>│  C  │────>└─────┘
(紅框)   FS │ D:7 │ FS  (紅框)
            │TF:0 │
            └─────┘
            (紅框)
```

- A → C → D 為要徑（紅色粗框）
- B 有 2 天浮時（黑色細框）
- 總工期 = 3 + 7 + 4 = 14 天
- B 和 C 在同一時間點開始（ES=3），垂直排列

---

## 常見問題

### Q1：為什麼我的網圖節點重疊？

**A**：
1. 點擊「自動縮放」按鈕
2. 使用滾輪縮小視圖
3. 拖曳移動到適當位置

### Q2：如何確認依賴關係是否正確？

**A**：
1. 點擊節點查看完整依賴列表
2. 檢查箭線的方向和類型
3. 確認 ES/EF/LS/LF 值是否合理

### Q3：要徑太長，如何優化？

**A**：
1. 找出要徑上工期最長的作業
2. 考慮是否能縮短工期（增加資源）
3. 檢查是否能改變依賴關係（平行施工）
4. 評估使用 SS 或 FF 依賴的可能性

### Q4：什麼時候應該使用 SS 而不是 FS？

**A**：當兩個作業可以部分重疊時：
- **FS**：B 必須等 A 完全結束（保守）
- **SS**：A 開始一段時間後，B 就可以開始（積極）
- **範例**：結構施工開始後不久，機電配管就可以進場

### Q5：Lag 值應該如何設定？

**A**：
- **正值**：強制延遲（如：混凝土養護期）
- **負值**：快速跟進（如：搶工）
- **範例**：
  - `FS (+7)`：澆置完成後養護 7 天
  - `SS (-2)`：前一作業開始前 2 天就開始準備

---

## 最佳實踐

### 1. 網圖設計
- 作業數量控制在 50 個以內
- 適度分解作業（太細會導致複雜）
- 清晰命名作業

### 2. 依賴關係
- 優先使用 FS（最簡單明瞭）
- 謹慎使用 SS/FF（確保邏輯正確）
- 避免使用 SF（容易混淆）

### 3. 視覺呈現
- 使用「自動縮放」確保全圖可見
- 適時切換「顯示詳細資訊」
- 截圖前調整至最佳視角

### 4. 分析流程
1. 先看整體佈局
2. 追蹤要徑
3. 檢查浮時分佈
4. 驗證依賴邏輯

---

## 進階技巧

### 趕工分析

當需要縮短工期時：
1. 在 PDM 網圖上找出要徑
2. 分析每個要徑作業的趕工可能性
3. 評估趕工成本和效果
4. 選擇性價比最高的作業進行趕工

### 資源衝突解決

當多個作業爭奪資源時：
1. 檢查有浮時的作業（藍色節點）
2. 將這些作業延後，避開衝突
3. 確保不超過其浮時限制

### 風險評估

1. 要徑作業（紅色）= 高風險
2. 浮時小的作業 = 中風險
3. 浮時大的作業 = 低風險

---

如有任何問題，請參考 `USER_GUIDE.md` 或提出 Issue！

