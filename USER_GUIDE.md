# 📚 使用者指南

## 目錄

1. [快速開始](#快速開始)
2. [功能說明](#功能說明)
3. [操作步驟](#操作步驟)
4. [範例專案](#範例專案)
5. [常見問題](#常見問題)
6. [技術說明](#技術說明)

---

## 快速開始

### 方式一：手動輸入

1. 在「作業名稱」欄位輸入作業名稱，例如：基礎開挖
2. 在「工期（天）」欄位輸入工期，例如：10
3. （可選）選擇前置作業或後續作業
4. 點擊「新增作業」按鈕
5. 重複步驟 1-4 直到所有作業都新增完成
6. 點擊「計算排程」按鈕查看結果

### 方式二：匯入 CSV

1. 點擊「下載範本」按鈕下載 CSV 範本
2. 使用 Excel 或文字編輯器編輯範本
3. 點擊「匯入 CSV」按鈕
4. 選擇您編輯好的 CSV 檔案
5. 系統會自動匯入並計算排程

---

## 功能說明

### 1. 作業輸入區

#### 欄位說明

- **作業名稱**（必填）
  - 工程或工作項目的名稱
  - 建議使用簡短明確的名稱
  - 範例：地質調查、結構設計、外牆裝修

- **工期（天）**（必填）
  - 該作業所需的工作天數
  - 必須為正整數
  - 範例：5、10、15

- **前置作業**（可選，支援多選）
  - 此作業開始前必須先完成的作業
  - 可以選擇多個前置作業
  - 點擊下方可用作業前的 + 按鈕來新增
  - 點擊已選作業上的 × 按鈕來移除
  - 不選代表起始作業

- **後續作業**（可選，支援多選）
  - 此作業完成後可以開始的作業
  - 可以選擇多個後續作業
  - 點擊下方可用作業前的 + 按鈕來新增
  - 點擊已選作業上的 × 按鈕來移除
  - 不選代表結束作業

#### 操作按鈕

- **新增作業**：將當前輸入的作業加入列表
- **刪除**：刪除某個已新增的作業
- **清空所有作業**：清除所有已新增的作業
- **計算排程**：執行 CPM 計算並顯示結果

### 2. CPM 計算結果

#### 專案總覽

- **專案總工期**：從開始到結束的總天數
- **要徑作業數量**：要徑上的作業總數

#### 要徑

- 以紅色標示的作業序列
- 這些作業的延遲會直接影響專案總工期
- 箭頭顯示作業之間的依賴順序

#### 詳細計算結果表格

| 欄位 | 說明 | 計算公式 |
|------|------|----------|
| ES | 最早開始時間 | max(前置任務的EF) |
| EF | 最早完成時間 | ES + Duration |
| LS | 最晚開始時間 | LF - Duration |
| LF | 最晚完成時間 | min(後續任務的LS) |
| TF | 總浮時 | LS - ES |
| FF | 自由浮時 | min(後續任務的ES) - EF |

#### 標記說明

- **要徑作業**：TF = 0 的作業，以紅色底色標示
- **起始**：沒有前置作業的作業
- **結束**：沒有後續作業的作業

### 3. 視覺化圖表

系統提供**分頁式圖表區**，可在Bar Chart和 PDM 網圖之間快速切換：

#### 如何切換視圖

在計算結果下方，您會看到兩個分頁按鈕：
- **📊 Bar Chart**：以時間軸方式顯示專案排程
- **🔗 PDM 網圖**：以節點網路方式顯示依賴關係

點擊任一分頁即可切換視圖，系統會保留您的縮放和操作狀態。

---

#### Bar Chart

##### 圖表元素

- **時間軸**：顯示專案時程（Day 0, Day 1, ...）
- **作業名稱**：左側列出所有作業
- **任務條**：
  - 藍色：一般作業
  - 紅色：要徑作業
  - 長度代表工期
- **依賴關係箭頭**：
  - 灰色：一般依賴
  - 紅色：要徑上的依賴

#### 互動功能

- **放大/縮小**：調整圖表顯示比例
- **重置**：恢復原始顯示比例
- **滑鼠懸停**：顯示作業詳細資訊
  - 作業名稱
  - 工期
  - ES/EF/LS/LF
  - 總浮時
  - 是否為要徑作業

---

#### PDM 節點式網圖

##### 圖表元素

- **節點（矩形框）**：採用標準九宮格佈局
  - 黃色背景 + 紅色粗框：要徑作業（TF = 0）
  - 黃色背景 + 黑色細框：一般作業（TF > 0）
  - 九宮格佈局：
    ```
    ┌───────┬───────┬───────┐
    │  ES   │ 作業  │  EF   │
    ├───────┼───────┼───────┤
    │       │ 工期  │       │
    ├───────┼───────┼───────┤
    │  LS   │  TF   │  LF   │
    └───────┴───────┴───────┘
    ```
    
- **箭線**：代表依賴關係
  - 紅色粗線：要徑
  - 灰色細線：一般依賴
  - 箭線上標示：
    - 依賴類型（FS/SS/FF/SF，非 FS 時顯示）
    - Lag 值（有 lag 時顯示，如：+3 或 -2）

##### 依賴類型說明

- **FS (Finish-to-Start)**：前置作業完成後，後續作業才能開始
- **SS (Start-to-Start)**：前置作業開始後，後續作業才能開始
- **FF (Finish-to-Finish)**：前置作業完成後，後續作業才能完成
- **SF (Start-to-Finish)**：前置作業開始後，後續作業才能完成

##### 顯示模式

系統提供兩種顯示模式：

**簡潔模式**（預設）
- 小型節點，只顯示作業名稱
- 綠色線條，統一配色
- Lag 標籤清晰顯示（如：Lag=3）
- 適合：快速瀏覽、簡報展示、複雜專案概覽

**詳細模式**
- 九宮格節點，顯示完整 CPM 資訊
- 要徑以紅色標示
- 顯示所有時間參數（ES/EF/LS/LF/TF）
- 適合：學習、驗證計算、詳細分析

##### 互動功能

- **滑鼠拖曳**：在畫布上拖曳移動視圖
- **滾輪縮放**：使用滑鼠滾輪放大/縮小圖表
- **重置視圖**：點擊「重置視圖」按鈕回到初始狀態
- **自動縮放**：點擊「自動縮放」按鈕自動調整至最佳顯示大小
- **切換模式**：在簡潔/詳細模式間切換
- **點擊節點**：顯示作業的完整詳細資訊（包含前置作業列表）

##### 佈局演算法

系統使用基於最早開始時間（ES）的橫向分層佈局：
- **橫向排列**：從左到右按時間順序排列
- 相同 ES 的作業排在同一垂直列
- 不同時間層級的作業橫向間隔
- **智能路徑規劃**（三大保證）：
  1. **不穿過節點**：精確碰撞檢測，自動避障
  2. **減少彎曲**：優先使用直線和三段式路徑
     - 直線：同水平且無障礙（零彎曲）
     - 三段式：標準路徑（兩個彎）
     - 繞行：僅必要時使用（最多三個彎）
  3. **不會重疊**：智能追蹤相似路徑，交替偏移
- 自動計算節點位置，清晰呈現專案邏輯流程

##### 使用建議

- **小型專案（< 15 個作業）**：PDM 網圖可以完整展示邏輯關係
- **複雜專案（> 15 個作業）**：可使用縮放和拖曳功能逐區檢視
- **教學用途**：PDM 網圖更適合解釋 CPM 計算過程
- **簡報展示**：使用自動縮放功能確保全圖可見

---

### 4. 匯入/匯出功能

#### 匯入 CSV

**檔案格式要求：**
```csv
作業名稱,工期(天),前置作業,後續作業
地質調查,5,,初步設計
初步設計,10,地質調查,結構設計
```

**注意事項：**
- 第一行必須是標題行
- 必填欄位：作業名稱、工期(天)
- 前置作業/後續作業可以為空
- 多個依賴關係用分號 `;` 或逗號 `,` 分隔
- 使用 UTF-8 編碼

#### 匯出作業

匯出當前的作業列表為 CSV 檔案，包含：
- 作業名稱
- 工期
- 前置作業
- 後續作業

#### 匯出結果

匯出 CPM 計算結果為 CSV 檔案，包含：
- 作業名稱
- 工期
- ES/EF/LS/LF
- TF/FF
- 是否為要徑作業

#### 匯出報告

生成完整的要徑分析報告（TXT 格式），包含：
- 專案總工期
- 要徑序列
- 要徑作業詳細資訊
- 其他作業浮時分析

---

## 操作步驟

### 情境 1：新建專案

1. 點擊「下載範本」取得 CSV 範本
2. 使用 Excel 編輯範本，輸入您的專案資料
3. 點擊「匯入 CSV」上傳檔案
4. 系統自動計算並顯示結果
5. 檢視 CPM 結果和Bar Chart
6. 需要時匯出報告

### 情境 2：小型專案（< 10 個作業）

1. 直接在介面上手動輸入作業
2. 依序建立作業之間的依賴關係
3. 點擊「計算排程」
4. 查看結果並調整（如有需要）

### 情境 3：修改現有專案

1. 匯入原有的 CSV 檔案
2. 使用「刪除」按鈕移除不需要的作業
3. 手動新增新的作業
4. 重新計算排程
5. 匯出更新後的資料

---

## 範例專案

### 範例 1：簡單線性專案

**專案說明**：5 個作業，依序執行

| 作業名稱 | 工期 | 前置作業 |
|----------|------|----------|
| 地質調查 | 5 天 | - |
| 初步設計 | 10 天 | 地質調查 |
| 結構設計 | 15 天 | 初步設計 |
| 發包準備 | 7 天 | 結構設計 |
| 開工動員 | 3 天 | 發包準備 |

**結果**：
- 總工期：40 天
- 要徑：所有作業
- 所有作業 TF = 0

### 範例 2：有分支的專案

**專案說明**：設計階段有兩個平行作業

| 作業名稱 | 工期 | 前置作業 |
|----------|------|----------|
| 地質調查 | 5 天 | - |
| 初步設計 | 10 天 | 地質調查 |
| 結構設計 | 15 天 | 初步設計 |
| 機電設計 | 12 天 | 初步設計 |
| 施工圖審查 | 7 天 | 結構設計、機電設計 |

**結果**：
- 總工期：37 天
- 要徑：地質調查 → 初步設計 → 結構設計 → 施工圖審查
- 機電設計有 3 天浮時

### 範例 3：複雜營建專案

詳見專案根目錄的 `example.csv` 檔案，包含 14 個作業的完整營建專案。

---

## 常見問題

### Q1：什麼是要徑？

**A**：要徑是專案中最長的作業序列，決定了專案的總工期。要徑上的任何作業延遲都會導致整個專案延遲。

### Q2：什麼是浮時（Float）？

**A**：浮時是指某個作業可以延遲的天數，而不會影響後續作業或專案總工期。

- **總浮時（TF）**：可延遲而不影響專案總工期的天數
- **自由浮時（FF）**：可延遲而不影響後續作業的天數

### Q3：為什麼會出現「檢測到循環依賴」？

**A**：當作業之間形成循環依賴時會出現此錯誤，例如：
- A 的後續是 B
- B 的後續是 C
- C 的後續是 A（形成循環）

請檢查並修正依賴關係。

### Q4：如何決定作業的順序？

**A**：作業順序由依賴關係自動決定，您只需要指定：
- 哪些作業必須先完成（前置作業）
- 哪些作業可以接著做（後續作業）

系統會自動計算最優的排程順序。

### Q5：可以有多個起始作業嗎？

**A**：可以！沒有前置作業的作業都會被視為起始作業，它們可以同時開始。

### Q6：匯入 CSV 時出現錯誤怎麼辦？

**A**：請檢查：
1. 檔案格式是否正確（UTF-8 編碼）
2. 第一行是否為標題行
3. 工期是否為正整數
4. 依賴關係中的作業名稱是否正確

### Q7：如何理解Bar Chart？

**A**：
- **橫軸**：時間（天數）
- **縱軸**：作業列表
- **藍色條**：一般作業的執行時段
- **紅色條**：要徑作業的執行時段
- **箭頭**：作業之間的依賴關係

---

## 技術說明

### CPM 演算法

本系統採用標準的要徑法（Critical Path Method），主要步驟：

1. **拓樸排序**（Kahn's Algorithm）
   - 確保作業按正確順序處理
   - 檢測循環依賴

2. **Forward Pass（前向計算）**
   ```
   ES = max(前置任務的EF)
   EF = ES + Duration
   ```

3. **Backward Pass（後向計算）**
   ```
   LF = min(後續任務的LS)
   LS = LF - Duration
   ```

4. **浮時計算**
   ```
   TF = LS - ES
   FF = min(後續任務的ES) - EF
   ```

5. **要徑識別**
   - TF = 0 的作業為要徑作業
   - 連接所有要徑作業形成要徑

### 資料結構

**作業資料結構**：
```typescript
interface CPMTask {
  id: string              // 唯一識別碼
  name: string            // 作業名稱
  duration: number        // 工期（天數）
  predecessors: string[]  // 前置作業ID
  successors: string[]    // 後續作業ID
  es?: number            // 最早開始時間
  ef?: number            // 最早完成時間
  ls?: number            // 最晚開始時間
  lf?: number            // 最晚完成時間
  tf?: number            // 總浮時
  ff?: number            // 自由浮時
  isCritical?: boolean   // 是否為要徑作業
}
```

### 效能限制

- 建議作業數量：< 50 個
- 最大作業數量：約 100 個（視瀏覽器效能而定）
- 要徑計算：< 1 秒
- Bar Chart渲染：< 2 秒

---

## 附錄

### 快捷鍵

- 在輸入框按 `Enter`：新增作業
- `Ctrl/Cmd + S`：（計劃中）儲存專案

### 瀏覽器相容性

- ✅ Chrome 90+
- ✅ Firefox 88+
- ✅ Safari 14+
- ✅ Edge 90+
- ❌ Internet Explorer（不支援）

### 檔案說明

- `example.csv`：複雜專案範例（14 個作業）
- `example_simple.csv`：簡單專案範例（5 個作業）
- `template.csv`：空白範本（可從系統下載）

---

如有任何問題或建議，請提出 Issue 或 Pull Request！

